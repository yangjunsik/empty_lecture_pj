# -*- coding: utf-8 -*-
"""2025í•´ì»¤í†¤.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1EmF_bUTRKAQYFI19VxKnGijSfvbAFSbI

# ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
"""

!pip install fastapi uvicorn nest-asyncio pyngrok

!apt install tesseract-ocr

!pip install pytesseract pillow fastapi uvicorn nest-asyncio pyngrok

!pip install python-jose[cryptography]

!pip install python-multipart

!pip install python-dotenv

from fastapi import FastAPI
from fastapi import HTTPException, Depends, Header
from fastapi.openapi.utils import get_openapi
from fastapi.openapi.models import APIKey, APIKeyIn, SecuritySchemeType
from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials
from fastapi import UploadFile, File
from fastapi.responses import JSONResponse
from fastapi import Depends

from jose import JWTError
from jose import  jwt

from dotenv import load_dotenv

import os

from pydantic import BaseModel

from datetime import datetime, timedelta
security = HTTPBearer()

import sqlite3

import shutil

import os
from fastapi import FastAPI, UploadFile, File, Form #ì‚¬ì§„

from PIL import Image
import pytesseract

from io import BytesIO

from typing import Optional

from PIL import Image

import pytesseract

from io import BytesIO
import sqlite3

app = FastAPI()

"""# JMT í•¨ìˆ˜"""

with open(".env", "w") as f:
    f.write("SECRET_KEY=my-super-secret-key")

#ì„ì˜ë¡œ ã„±

load_dotenv()

SECRET_KEY = os.getenv("SECRET_KEY")
ALGORITHM = "HS256"

print(SECRET_KEY)

def decode_token(token: str):
    try:
        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
        return payload.get("sub")
    except JWTError:
        raise HTTPException(status_code=401, detail="í† í°ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")

"""# ë³´ì•ˆ"""

from fastapi.openapi.utils import get_openapi

def custom_openapi():
    if app.openapi_schema:
        return app.openapi_schema

    openapi_schema = get_openapi(
        title="ë¹ˆê°•ì˜ì‹¤ ê´€ë¦¬ ì‹œìŠ¤í…œ",
        version="1.0.0",
        description="JWT ì¸ì¦ í¬í•¨ Swagger ë¬¸ì„œ",
        routes=app.routes,
    )
    openapi_schema["components"]["securitySchemes"] = {
        "BearerAuth": {
            "type": "http",
            "scheme": "bearer",
            "bearerFormat": "JWT"
        }
    }
    for path in openapi_schema["paths"].values():
        for operation in path.values():
            operation["security"] = [{"BearerAuth": []}]
    app.openapi_schema = openapi_schema
    return app.openapi_schema

app.openapi = custom_openapi

"""# ì‚¬ìš©ì í† í°"""

def create_token(user_id: str):
    payload = {
        "sub": user_id,
        "exp": datetime.utcnow() + timedelta(hours=1)
    }
    return jwt.encode(payload, SECRET_KEY, algorithm=ALGORITHM)

print(create_token("user1"))

"""# DB ìƒì„±"""

conn = sqlite3.connect("users.db")
cur = conn.cursor()

# users í…Œì´ë¸” ìƒì„±
cur.execute("""
CREATE TABLE IF NOT EXISTS users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    student_id TEXT,
    name TEXT,
    phone TEXT
)
""")

# ì‚¬ìš©ì í•˜ë‚˜ ì¶”ê°€
cur.execute("""
INSERT INTO users (student_id, name, phone) VALUES (?, ?, ?)
""", ("20240001", "ê¹€ë¯¼ì§€", "01012345678"))

# í™•ì¸
cur.execute("SELECT * FROM users")
for row in cur.fetchall():
    print(row)

conn.commit()
conn.close()

"""# DB ì¡°íšŒ"""

def get_reservation_from_db(reserve_id: int):
    conn = sqlite3.connect("reservations.db")
    cursor = conn.cursor()
    cursor.execute("SELECT user_id, room_id FROM reservations WHERE id = ?", (reserve_id,))
    row = cursor.fetchone()
    conn.close()

    if row:
        return {"user_id": row[0], "room_id": row[1]}
    else:
        return None

"""# ë¡œê·¸ì¸"""

def get_db():
    conn = sqlite3.connect("users.db")
    conn.row_factory = sqlite3.Row
    return conn

@app.post("/login")
def login(student_id: str = Form(...), name: str = Form(...), phone: str = Form(...)):
    conn = get_db()
    cur = conn.cursor()
    cur.execute("""
    SELECT * FROM users
    WHERE student_id = ? AND name = ? AND phone = ?
    """, (student_id, name, phone))
    user = cur.fetchone()

    if user:
        return {"success": True, "message": "ë¡œê·¸ì¸ ì„±ê³µ"}
    else:
        return {"success": False, "message": "ë¡œê·¸ì¸ ì‹¤íŒ¨"}

"""# ê°•ì˜ì‹¤ ì •ë³´"""



"""# ê°•ì˜ì‹œê°„í‘œ"""



"""# ë³´ì¦í¬ì¸íŠ¸ (ë³´ë¥˜)

- ë‚´ í¬ì¸íŠ¸
"""



"""- í¬ì¸íŠ¸ ì´ë ¥"""



"""- í¬ì¸íŠ¸ ì„¤ëª…

# í…ŒìŠ¤íŠ¸ìš© JWT ìƒì„±ê¸°
"""

!ngrok config add-authtoken "2xY2WVmlvhaDE3oxlQE4PbG0bnL_42qcjEv2FGLFfMZUaLTQP"

import threading

from pyngrok import ngrok
import uvicorn

def run_app():
    uvicorn.run(app, host="0.0.0.0", port=8000)

thread = threading.Thread(target=run_app)
thread.start()

public_url = ngrok.connect(8000)
print("ğŸ”— Swagger ì£¼ì†Œ:", public_url.public_url + "/docs")

"""# ë°ì´í„°ì…‹"""

user_reservations = {
    1: {
        "user_id": "user1",
        "room_id": 9,
        "start_time": "2025-05-25T10:00:00",
        "end_time": "2025-05-25T12:00:00",
        "status": "reserved"
    }
}
